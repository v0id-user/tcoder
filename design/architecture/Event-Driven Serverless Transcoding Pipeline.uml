@startuml
!theme plain
'--- Visual Styling ---
skinparam boxPadding 10
skinparam participantPadding 10
autonumber "<b>[0]"

'--- Actors and Components ---
actor Client as "User Client"
box "Cloudflare Ecosystem" #e3f2fd
    participant Worker as "Worker API"
    database R2 as "R2 Storage"
end box

box "Compute Infrastructure" #fff3e0
    participant Fly as "Fly.io Machine"
end box

box "Distribution" #f3e5f5
    participant CDN as "Bunny CDN"
end box

'--- 1. Authorization Phase ---
== 1. Authorization Phase ==
Client -> Worker: Request Upload Permission
activate Worker
Worker -> R2: Generate Presigned PUT URL
R2 --> Worker: Return Signed URL
Worker --> Client: Forward Presigned URL
deactivate Worker

'--- 2. Ingestion Phase ---
== 2. Ingestion Phase ==
Client -> R2: Direct Upload (Raw Video)
R2 -[#blue]> Worker: Event Notification (Object Created)

'--- 3. Processing Phase ---
== 3. Processing Phase ==
Worker -> Fly: Trigger Transcoding Job
activate Fly
Fly -> R2: Download Raw Video
Fly -> Fly: Generate Qualities\n(480p, 720p, 1080p)
Fly -> R2: Upload Processed Qualities
deactivate Fly

'--- 4. Discoverability Phase (The Missing Link) ---
== 4. Discoverability Phase ==
note over Worker, Client: Client becomes aware of the new URLs
Fly -> Worker: Webhook: Processing Complete (New URLs)
activate Worker
Worker -> Worker: Update Video Status in DB
Worker -->> Client: Push Notification / WebSocket (Video Ready)
deactivate Worker

'--- 5. Distribution Phase ---
== 5. Distribution Phase ==
Client -> CDN: Pull Video via New URL
activate CDN
alt Cache Miss
  CDN -> R2: Origin Fetch (if not cached)
  R2 --> CDN: Video Data
end
CDN --> Client: Stream Video
deactivate CDN
@enduml
