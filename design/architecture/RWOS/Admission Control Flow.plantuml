@startuml RWOS Admission Control Flow
!theme plain
skinparam boxPadding 10
skinparam participantPadding 8
autonumber "<b>[0]"

title Admission Control Flow - Pool-Based Capacity Management

participant CF as "Cloudflare Worker\n(Control Plane)"
database Redis as "Upstash Redis"
participant Fly as "Fly Machines API"

== Check Stopped Machines First ==
CF -> Redis: SPOP machines:stopped
Redis --> CF: machine_id or null

alt machine_id found (Reuse)
    note right of CF: Reuse Stopped Machine
    CF -> Fly: POST /apps/{app}/machines/{id}/start
    Fly --> CF: Machine started
    CF -> Redis: HSET machines:pool\n{ state: "running", lastActiveAt }
    CF -> Redis: SREM machines:stopped
    CF --> CF: Return { job_id, machine_id }
else no stopped machines (Create New)
    == Pool Capacity Check ==
    CF -> Redis: HGETALL machines:pool
    Redis --> CF: pool_entries (running + stopped)

    alt pool_size >= MAX_MACHINES (10)
        note right of CF: Pool Full
        CF --> CF: Return "queued" status\n(Job waits for existing workers)
    else pool_size < MAX_MACHINES
        note right of CF: Pool Capacity Available

        == Create Machine ==
        CF -> Fly: POST /apps/{app}/machines\n(with exponential backoff)

        alt 429 or 5xx
            CF -> CF: Backoff and retry
            CF -> Fly: Retry create
        end

        Fly --> CF: { id: machine_id, state: "started" }

        == Add to Pool ==
        CF -> Redis: HSET machines:pool\n{ state: "running", lastActiveAt, createdAt }

        CF --> CF: Return { job_id, machine_id }
    end
end

@enduml

