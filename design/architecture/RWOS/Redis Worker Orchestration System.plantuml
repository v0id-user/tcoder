@startuml Redis Worker Orchestration System
!theme plain
skinparam componentStyle rectangle
skinparam linetype ortho
skinparam maxMessageSize 50
skinparam packageStyle rectangle

title RWOS - Redis Worker Orchestration System

' Top: Control Plane (grouped horizontally)
package "Control Plane" #e3f2fd {
    [Hono API] as API
    [Admission\nController] as AdmCtrl
    [Machine\nSpawner] as Spawner
    [Cron\nHandler] as Cron
}

' Middle: Redis State (grouped in columns)
package "Redis State Store" #fff8e1 {
    database "jobs:pending" as JobQueue
    database "jobs:active" as ActiveJobs
    database "jobs:status" as JobStatus
    database "machines:pool" as MachinePool
    database "machines:stopped" as StoppedMachines
}

' Bottom: Execution Layer
package "Execution Layer" #fff3e0 {
    node "Worker\n(Poll Indefinitely)" as W1
}

cloud "R2 Storage" as R2 #f3e5f5

' Job Submission Flow (vertical, top to bottom)
API --> JobQueue : "1. Enqueue"
API --> AdmCtrl : "2. Check"
AdmCtrl --> MachinePool : "3. Check Pool Size"
AdmCtrl --> StoppedMachines : "4. Check Stopped"
AdmCtrl --> Spawner : "5. Spawn/Start"
Spawner --> W1 : "6. Create/Start"

' Worker Processing Flow (bottom to top)
W1 --> MachinePool : "7. Update State\n(running/idle)"
W1 --> JobQueue : "8. Pop"
W1 --> ActiveJobs : "9. Claim"
W1 --> JobStatus : "10. Update"
W1 --> R2 : "11. Storage"
W1 --> API : "12. Webhook"

' Maintenance Flow
Cron --> MachinePool : "Stop Idle\n(idle > 5min)"
Cron --> StoppedMachines : "Add to Stopped"

@enduml
