@startuml RWOS Worker Lifecycle
!theme plain
skinparam stateFontSize 12

title Worker Lifecycle - Pooled Indefinite Polling

[*] --> Starting : Machine Started\n(via Machines API or Pool)

state Starting {
    Starting : Connect to Redis
    Starting : Read env variables
    Starting : Initialize in pool\n(HSET machines:pool)
}

Starting --> Running : Pool Entry Created\n(state: "running")

state Running {
    Running : Polling job queue\n(indefinitely)
    Running : Update lastActiveAt
}

Running --> Processing : ZPOPMIN returns job

state Processing {
    Processing : Download from R2
    Processing : FFmpeg transcode
    Processing : Upload to R2
    Processing : Update Redis status
    Processing : Send webhook
    Processing : Update pool state\n(state: "running")
}

Processing --> Running : Job Complete\nUpdate lastActiveAt

Running --> Idle : ZPOPMIN returns null\n(no jobs available)

state Idle {
    Idle : Update pool state\n(state: "idle")
    Idle : Update lastActiveAt
    Idle : Sleep POLL_INTERVAL
}

Idle --> Running : Continue polling

Idle --> [*] : Stopped by Cron\n(idle > 5 minutes)\n(Machines_stop API)

note right of Running
  **Constants:**
  POLL_INTERVAL = 5s
  IDLE_TIMEOUT = 5 minutes
  Workers poll indefinitely
  No TTL or drain logic
end note

note right of Processing
  **Job Status Updates:**
  pending → running → completed/failed
  All tracked in Redis HASH
end note

note right of Idle
  **Pool State:**
  machines:pool tracks state
  Cron stops idle machines
  Stopped machines reused
end note

@enduml

